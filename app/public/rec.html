<!DOCTYPE html>
<html>
    
<head>
    <meta charset="utf-8" />
    <title>Recipe</title>

    <style>
        td {
             border-collapse: collapse;
             border: 1px solid black;
             padding: 10px;
         }
     </style>
</head>

<body>
    <div class='page-links'>
        <nav>
      
            <a href = "./index.html">Home</a>
            <a href = "./login.html">Login</a>
            <a href = "./rec.html">Get Recommendations</a>
            <a href = "./pantry.html">Pantry</a>
            <a href = "./shopping.html">Shopping List</a>
            <a href = "./recipebook.html">Recipe Book</a>
            
         </nav>
    </div>

    <div id="info">

    </div>
    
    <div>
        <label for="query">Search:</label>
        <input id="query" type="text" />
    </div>

    <div>
        <label for="meal-type">Meal Type:</label>
        <select name="meal-type" id="meal-select">
            <option value="">Please select a meal type</option>
            <option value="Breakfast">Breakfast</option>
            <option value="Lunch">Lunch</option>
            <option value="Dinner">Dinner</option>
            <option value="Snack">Snack</option>
            
        </select>
    </div>

    <div>
        <label for="folder-name">Folder Name:</label>
        <select name="folder-name" id="folder-name">
            <option value="">Please select a folder</option>
            <option value="To Be Cooked">To Be Cooked</option>
            <option value="Liked">Liked</option>
           
        </select>
    </div>

    <button id="send">Recipe</button>
    <button id="saverecipe-btn">Save to Recipe Book</button>
    <label for="healthfilter">Choose a dietary filter:</label>
    <select name="healthfilter" id="HealthFilter">
        <option value="none">None</option>
        <option value="vegetarian">Vegetarian</option>

    </select>

    <div>
    <label class="switch">Only show recipes that use current pantry items:
    	  <input type="checkbox" id="IngredientFilter">
    </label>
    </div>

    <div id="err"></div>

    <table id="data-table"> 
        <thead>
            <tr>
                <td style="font-weight: bold;">
                    Recipe Name
                </td>
                <td style="font-weight: bold;">
                    Ingredients
                </td>
                <td style="font-weight: bold;">
                    Calories
                </td>
                <td style="font-weight: bold;">
                    Image
                </td>
            </tr>
        </thead>
        
    </table>

    <script src="functions.js"></script>
    
    <script>

        //recipe.health label
        function healthfilter(recipes, filter) {
            let filtered = [];
            for (let recipe of recipes) {
                console.log(recipe);
                let labels = recipe.recipe.healthLabels;
                for (let label of labels) {
                    if (label === filter) {
                        filtered.push(recipe);
                    }
                }
            }
            return filtered;
        }

        //calculates how many more ingredients are needed compared to what is in the pantry
        function ingredient_disparity(recipes, ingredient_list) {
            for (let recipe of recipes) {
                let required_ingredients = [];
                for (let recipe_ingredient of recipe.ingredients) {
                    let disparity = recipe.ingredients.length();
                    let initial = disparity;
                    for (let ingredient of ingredient_list) {
                        if (recipe_ingredient === ingredient) {
                            disparity -= 1;
                        } 
                    }
                    if (disparity === initial) {
                        required_ingredients.push(recipe_ingredient);
                    }
                }
                recipe["disparity"] = disparity;
                recipe["shopping_list"] = required_ingredients;
            }
        }

	function comparePantryAndRecipe(recipe) {
		let found = false;
		for (let ingredient of recipe.recipe.ingredients) {
			for (let pantryItem of pantryList) {
				if (pantryItem.item_name === capitalizeFirstLetter(ingredient.food)) {
					found = true;
					break;
				}
			}
			if (!found)
				return false;
			found = false;
		}
		return true;
	}

	function capitalizeFirstLetter(string) {
  		return string.charAt(0).toUpperCase() + string.slice(1);
	}


        let query_input = document.getElementById("query");
        let mealtype_input = document.getElementById("meal-select");
        let btn = document.getElementById("send");
        let table = document.getElementById("data-table");
        let folder_name = document.getElementById("folder-name");
	  let ingredientFilter = document.getElementById("IngredientFilter");
	  let err = document.getElementById("err");
	  let pantryList = null;
	  let body = null;

        let tbody = document.createElement("tbody");
        tbody.id = "t-body";
        table.append(tbody);
        let start_tbody = document.getElementById("t-body");
        

        table.style.border = '1px solid black';
        table.style.borderCollapse = 'collapse';
        table.style.padding = '3px';
        table.style.tableLayout = 'fixed';

	  fetch("/viewpantrylist")
        .then((response) => {
		  return response.json();
	  }).then((data) => {
		  pantryList = data.rows;
	  });

	  //AVERY 11/20/2022
	  function func(ingredientFilter) {
		let results = 0;

		err.textContent = "";

		//AVERY 11/20/2022
            let recipes = body.data1.hits.concat(body.data2.hits);

		console.log(comparePantryAndRecipe(body.data1.hits[0]))

            let rows = Object.keys(recipes).length;

            if (tbody.hasChildNodes())
            {   
            	for (let i = tbody.children.length - 1; i >= 0; i--) {  
                  	tbody.children[i].remove();
                	}
            }

            //filters if filter is selected
             let filter = document.getElementById("HealthFilter").value;
             console.log(recipes);
             console.log(filter);
            if (filter === "vegetarian") {
            	recipes = healthfilter(recipes, "Vegetarian");
            } 

            for (let i = 0; i < rows; i++) {
			if (!comparePantryAndRecipe(recipes[i]) && ingredientFilter) {
				continue;
			}
			results += 1;
                  let tr = document.createElement('tr');

                  tbody.append(tr);
                  let td1 = document.createElement('td');
                  tr.append(td1);
                  td1.textContent = recipes[i].recipe.label;
                  let td2 = document.createElement('td');
                  tr.append(td2);
                  let ingr_rows = recipes[i].recipe.ingredientLines.length;

                  let ul = document.createElement('ul');
                  td2.append(ul);
                  for (let j = 0; j < ingr_rows; j++) {
                  	let li = document.createElement('li');
                        ul.append(li);
                        li.textContent = recipes[i].recipe.ingredientLines[j];
                  }
                        
                        let td3 = document.createElement('td');
                        tr.append(td3);
                        td3.textContent = Math.round(recipes[i].recipe.calories);
                        let td4 = document.createElement('td');
                        tr.append(td4);
                        food_img = document.createElement('img');
                        td4.append(food_img);
                        food_img.src = recipes[i].recipe.image;
                        
                        td4 = document.createElement('td');
                        tr.append(td4);

                        let save_cb = document.createElement('input');
                        
                        save_cb.type = "checkbox";
                        save_cb.class = "saverecipe";
                        save_cb.name = "saverecipe";
                        td4.append(save_cb);
                    }

			  //AVERY 11/20/2022
			  if (results == 0) {
				  err.textContent = "No results";
			  }
	  }

	  //AVERY 11/20/2022
        btn.addEventListener("click", () => {
		let q_input = query_input.value;
            let meal_input = mealtype_input.value;
            let q_string = `/recipe?search=${q_input}&mealtype=${meal_input}`;

		err.textContent = "";

            fetch(q_string)
            .then((response) => {
            	return response.json()
            }).then((data) => {
			body = data;
			
			if (ingredientFilter.checked)
				func(true);
			else
				func(false);
		});
	  });

	let cb = document.getElementsByName("saverecipe");
      let save_btn = document.getElementById("saverecipe-btn");

      save_btn.addEventListener("click", () => {
		for (let i = 0; i < cb.length; i++) {
			if (cb[i].checked) {
				console.log(folder_name.value);
                        fetch("/saverecipe", {
				method: "POST",
                        	headers: {
                              "Content-Type": "application/json"
                              },
                                    
                              body: JSON.stringify({
                              	recipe: alt_recipes[i].recipe,
                                    folder_name: folder_name.value
                              })
				})
				.then((response) => {
					response.text();
				}).then((body) => {
					console.log("success");
				});
			}
		}
	});

	ingredientFilter.addEventListener("click", () => {
		if (ingredientFilter.checked)
			func(true);
		else
			func(false);
	});
        
        
    </script>
</body>

</html>