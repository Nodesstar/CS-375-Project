<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Pantry</title>
<style>

</style>
</head>
<body>

    <nav>
      
        <a href = "./index.html">Home</a>
            <a href = "./login.html">Login</a>
            <a href = "./rec.html">Get Recommendations</a>
            <a href = "./pantry.html">Pantry</a>
            <a href = "./shopping.html">Shopping List</a>
            <a href = "./recipebook.html">Recipe Book</a>
        
     </nav>
     
     <div class="dropdown"> 
     <label for="item">Item Name:</label>
     		<div id="myDropdown" class="dropdown-content">
			<input type="text" placeholder="Search.." id="item" onkeyup="filterFunction()">
    			<select name="ingredients" id="ingredients">
    				
			</select>
  		</div>
     </div>

     <button id="add-line">
        Add
    </button>

    <h2>
        Pantry List
    </h2>

    <div id="err"></div>

    <div id="pantry-list">
        <ul id="start">

        </ul>

    </div>

    <button id="save-btn">
        Save
    </button>

    <button id="view-btn">
        View Pantry List
    </button>

    <div> 
        <ul id="view-pantry">

        </ul>
    </div>

<script>

function filterFunction() {
  let input, filter, a, i;
  input = document.getElementById("item");
  filter = input.value.toUpperCase();
  div = document.getElementById("myDropdown");
  options = div.getElementsByTagName("option");
  for (i = 0; i < options.length; i++) {
    txtValue = options[i].textContent || options[i].innerText;
    if (txtValue.toUpperCase().indexOf(filter) > -1) {
      options[i].style.display = "";
    } else {
      options[i].style.display = "none";
    }
  }
} 

function capitalizeFirstLetter(string) {
  	return string.charAt(0).toUpperCase() + string.slice(1);
}

let pantry = document.getElementById("pantry-list");
let btn = document.getElementById("add-line");
let list = document.getElementById("start");
let ingredient = document.getElementById("ingredients");
let save_btn = document.getElementById("save-btn");
let view_btn = document.getElementById("view-btn");
let pantry_ul = document.getElementById("view-pantry");
let err = document.getElementById("err");

btn.addEventListener("click", () => {
   	let li = document.createElement("li");
	let found = false;

    	for (let element of list.children) {
		if (element.textContent == ingredient.value) {
			found = true;
			break;
		}
   	}
	if (found) {
		err.textContent = "Item already in list";
	} else {
		err.textContent = "";
		list.append(li);
    		li.textContent = ingredient.value;
	}
});

fetch("/ingredients")
.then((response) => {
	return response.json();
}).then((data) => {
	let ing = document.getElementById("ingredients");

	for (let meal of data.rows) {
		let option = document.createElement("option");
		option.value = capitalizeFirstLetter(meal.item_name);
		option.textContent = capitalizeFirstLetter(meal.item_name);

		ing.appendChild(option);
	}
});

save_btn.addEventListener("click", () => {
    	let n_items = list.children.length;
	let found = false;
  
    	let pantry_str = "";
	err.textContent = "";

    	fetch("/viewpantrylist")
    	.then((response) => {
        	return response.json()
        	.then((body) => {
			console.log(list.children);
            		for (let item of list.children) {
				for (let pantryItem of body.rows) {
					if (item.textContent === pantryItem.item_name) {
						found = true;
						break;
					}
				}
				if (!found) {
					pantry_str += `${item.textContent},`;
				}
				found = false;
			}

			let q_string = `/pantry?${pantry_str}`;

    			fetch("/pantry", {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
        
				body: JSON.stringify({
					items: pantry_str
				})
			})
    			.then((response) => {
        			console.log("good");
    			});

    			while (list.children.length)
    			{
        			list.lastElementChild.remove();
    			}
        	});
    	});
});

view_btn.addEventListener("click", () => {
    err.textContent = "";

    fetch("/viewpantrylist")
    .then((response) => {
        response.json()
        .then((body) => {
            
            console.log(pantry_ul.children.length);
            while (pantry_ul.children.length)
            {
                
                pantry_ul.lastElementChild.remove();
            }

            for (let i = 0; i < body.rows.length; i++)
            {
                
                let li = document.createElement("li");
                pantry_ul.append(li);
                li.textContent = body.rows[i].item_name;
            }
            
        });
    });
});
</script>

</body>
</html>
